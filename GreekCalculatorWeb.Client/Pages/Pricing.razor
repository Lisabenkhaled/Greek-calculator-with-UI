@page "/pricing"
@using Shared.DTO
@using Shared.Enums
@using GreekCalculatorWeb.Client.State
@using System.Globalization
@inject HttpClient Http
@inject AppState AppState

<h2 class="page-title">OPTION PRICER</h2>

<div class="pricing-grid-2cols">

    <!-- =============== LEFT: MARKET =============== -->
    <div class="card violet-card">
        <h3 class="card-title violet-title option-title-strong">March√© Param√®tres</h3>

        <div class="form-section">

            <!-- TICKER -->
            <div class="field">
                <label>Ticker</label>
                <input class="input"
                       value="@TickerText"
                       @oninput="OnTickerChanged" />
            </div>

            <!-- SPOT -->
            <div class="field">
                <label>Spot</label>
                <input type="text"
                       class="input @(HasError("Spot") ? "input-error" : "")"
                       value="@SpotText"
                       @oninput="OnSpotChanged" />

                @InlineError("Spot")
            </div>

            <!-- VOLATILITY -->
            <div class="field">
                <label>Volatilit√© (d√©cimal)</label>
                <input type="text"
                       class="input @(HasError("Vol") ? "input-error" : "")"
                       value="@VolText"
                       @oninput="OnVolChanged" />

                @InlineError("Vol")
            </div>

            <!-- RATE -->
            <div class="field">
                <label>Taux sans risque (d√©cimal)</label>
                <input type="text"
                       class="input @(HasError("Rate") ? "input-error" : "")"
                       value="@RateText"
                       @oninput="OnRateChanged" />

                @InlineError("Rate")
            </div>

        </div>
    </div>

    <!-- =============== RIGHT: OPTION =============== -->
    <div class="card violet-card">
        <h3 class="card-title violet-title option-title-strong">Option Param√®tres</h3>

        <div class="form-section">

            <!-- STRIKE -->
            <div class="field">
                <label>Strike (K)</label>
                <input type="text"
                       class="input @(HasError("Strike") ? "input-error" : "")"
                       value="@StrikeText"
                       @oninput="OnStrikeChanged" />

                @InlineError("Strike")
            </div>

            <!-- MATURITY -->
            <div class="field">
                <label>Maturit√© (ann√©es)</label>
                <input type="text"
                       class="input @(HasError("Maturity") ? "input-error" : "")"
                       value="@MaturityText"
                       @oninput="OnMaturityChanged" />

                @InlineError("Maturity")
            </div>

            <!-- DIVIDEND -->
            <div class="field">
                <label>Dividend Yield</label>
                <input type="text"
                       class="input @(HasError("Dividend") ? "input-error" : "")"
                       value="@DividendText"
                       @oninput="OnDividendChanged" />

                @InlineError("Dividend")
            </div>

            <!-- TYPE -->
            <div class="field">
                <label>Option Type</label>
                <select class="input select-black" @bind="model.OptionType">
                    <option value="@OptionType.Call">Call</option>
                    <option value="@OptionType.Put">Put</option>
                </select>
            </div>

            <!-- STYLE -->
            <div class="field">
                <label>Option Style</label>
                <select class="input select-black" value="@model.OptionStyle" @onchange="OnOptionStyleChanged">
                    <option value="@OptionStyle.European">European</option>
                    <option value="@OptionStyle.American">American</option>
                </select>
            </div>

        </div>
    </div>
</div>

<!-- =============== PRICING METHOD =============== -->
<div class="card violet-card pricing-method-card">
    <h3 class="card-title violet-title option-title-strong">Pricing M√©thode</h3>

    <div class="pricing-method-grid">

        <div class="field">
            <select class="input select-black" value="@model.PricingMethod" @onchange="OnPricingMethodChanged">
                <option value="@PricingMethod.BlackScholes">Black-Scholes</option>
                <option value="@PricingMethod.Binomial">Binomial Tree</option>
                <option value="@PricingMethod.MonteCarlo">Monte Carlo</option>
                <option value="@PricingMethod.LSMMonteCarlo">LSM Monte Carlo</option>
            </select>

            <!-- WARNING COMBINATION -->
            @if (PricingCompatibilityWarning() is string warn)
            {
                <div class="field-error">@warn</div>
            }
        </div>

        <button class="btn-primary"
                @onclick="Calculate"
                disabled="@HasErrors()">
            ‚ñ∂ Calculer Prix
        </button>

    </div>
</div>

<!-- =============== RESULT =============== -->
<div class="card blue-card result-container">
    <h3 class="card-title blue-title option-title-strong">R√©sultat</h3>

    @if (PriceResult is not null && PricingCompatibilityWarning() == null)
    {
        <p class="result-value">üí∞ @PriceResult.Value.ToString("F4")</p>
    }
    else if (PricingCompatibilityWarning() == null)
    {
        <p class="result-placeholder">Aucun r√©sultat pour le moment.</p>
    }
</div>

@code {

    /* ===========================
     *   VALIDATION & ERRORS
     * =========================== */
    Dictionary<string, string?> FieldErrors = new();

    bool HasError(string key)
        => FieldErrors.TryGetValue(key, out var msg) && msg != null;

    bool HasErrors()
        => FieldErrors.Values.Any(v => v != null);

    RenderFragment InlineError(string key) => builder =>
    {
        if (HasError(key))
        {
            builder.OpenElement(0, "div");
            builder.AddAttribute(1, "class", "field-error");
            builder.AddContent(2, $"‚ö†Ô∏è {FieldErrors[key]}");
            builder.CloseElement();
        }
    };

    void SetError(string key, string? msg)
    {
        FieldErrors[key] = msg;
        StateHasChanged();
    }

    /* ===========================
     *   TEXT FIELDS (STRING INPUT)
     * =========================== */
    string TickerText   = "AAPL";
    string SpotText     = "100";
    string VolText      = "0.20";
    string RateText     = "0.05";
    string StrikeText   = "100";
    string MaturityText = "1";
    string DividendText = "0";

    /* ===========================
     *   MODEL
     * =========================== */
    PricingRequest model = new()
    {
        Ticker = "AAPL",
        Spot = 100,
        Strike = 100,
        Vol = 0.20,
        Rate = 0.05,
        DividendYield = 0.0,
        Maturity = 1,
        OptionType = OptionType.Call,
        OptionStyle = OptionStyle.European,
        PricingMethod = PricingMethod.BlackScholes
    };

    double? PriceResult = null;

    /* ===========================
     *   COMPATIBILITY WARNINGS
     * =========================== */
    string? PricingCompatibilityWarning()
    {
        if (model.OptionStyle == OptionStyle.American)
        {
            if (model.PricingMethod == PricingMethod.BlackScholes)
                return "‚ùå Black-Scholes ne fonctionne pas pour les options am√©ricaines.";

            if (model.PricingMethod == PricingMethod.MonteCarlo)
                return "‚ùå Monte Carlo standard ne g√®re pas l‚Äôexercice anticip√©.";
        }

        if (model.OptionStyle == OptionStyle.European)
        {
            if (model.PricingMethod == PricingMethod.LSMMonteCarlo)
                return "‚ùå LSM Monte Carlo est une m√©thode con√ßue pour les options am√©ricaines uniquement.";
        }

        return null;
    }


    /* ===========================
     *   PARSING
     * =========================== */
    bool TryParse(string? s, out double value)
    {
        s = s?.Replace(",", ".");
        return double.TryParse(s, NumberStyles.Any, CultureInfo.InvariantCulture, out value);
    }

    /* ===========================
     *   INPUT HANDLERS
     * =========================== */
    void OnTickerChanged(ChangeEventArgs e)
    {
        TickerText = e.Value?.ToString() ?? "";
        model.Ticker = TickerText;
    }

    void OnSpotChanged(ChangeEventArgs e)
    {
        SpotText = e.Value?.ToString() ?? "";

        if (!TryParse(SpotText, out var v))
            SetError("Spot", "Num√©rique invalide");
        else if (v <= 0)
            SetError("Spot", "Doit √™tre > 0");
        else
        {
            model.Spot = v;
            SetError("Spot", null);
        }
    }

    void OnVolChanged(ChangeEventArgs e)
    {
        VolText = e.Value?.ToString() ?? "";

        if (!TryParse(VolText, out var v))
            SetError("Vol", "Num√©rique invalide");
        else if (v <= 0)
            SetError("Vol", "Doit √™tre > 0");
        else
        {
            model.Vol = v;
            SetError("Vol", null);
        }
    }

    void OnRateChanged(ChangeEventArgs e)
    {
        RateText = e.Value?.ToString() ?? "";

        if (!TryParse(RateText, out var v))
            SetError("Rate", "Num√©rique invalide");
        else if (v < -0.10)
            SetError("Rate", "Minimum = -10%");
        else
        {
            model.Rate = v;
            SetError("Rate", null);
        }
    }

    void OnStrikeChanged(ChangeEventArgs e)
    {
        StrikeText = e.Value?.ToString() ?? "";

        if (!TryParse(StrikeText, out var v))
            SetError("Strike", "Num√©rique invalide");
        else if (v <= 0)
            SetError("Strike", "Doit √™tre > 0");
        else
        {
            model.Strike = v;
            SetError("Strike", null);
        }
    }

    void OnMaturityChanged(ChangeEventArgs e)
    {
        MaturityText = e.Value?.ToString() ?? "";

        if (!TryParse(MaturityText, out var v))
            SetError("Maturity", "Num√©rique invalide");
        else if (v <= 0)
            SetError("Maturity", "Doit √™tre > 0");
        else
        {
            model.Maturity = v;
            SetError("Maturity", null);
        }
    }

    void OnDividendChanged(ChangeEventArgs e)
    {
        DividendText = e.Value?.ToString() ?? "";

        if (!TryParse(DividendText, out var v))
            SetError("Dividend", "Num√©rique invalide");
        else if (v < 0)
            SetError("Dividend", "Doit √™tre ‚â• 0");
        else
        {
            model.DividendYield = v;
            SetError("Dividend", null);
        }
    }

    void OnPricingMethodChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<PricingMethod>(e.Value?.ToString(), out var method))
            model.PricingMethod = method;

        StateHasChanged(); 
    }

    void OnOptionStyleChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<OptionStyle>(e.Value?.ToString(), out var style))
            model.OptionStyle = style;

        StateHasChanged(); 
    }


    /* ===========================
     *   CALCULATE
     * =========================== */
    public async Task Calculate()
    {
        if (HasErrors() || PricingCompatibilityWarning() != null)
            return;

        var r = await Http.PostAsJsonAsync("api/pricing", model);

        if (r.IsSuccessStatusCode)
        {
            PriceResult = await r.Content.ReadFromJsonAsync<double>();
            AppState.LastPricing = model;
        }
    }
}

<style>

/* ---- TITRE ---- */
.page-title {
    font-size: 2.3rem;
    text-align: center;
    font-weight: 900;
    margin-bottom: 1.5rem;
    color: #4b0082;
}

/* ---- GRID ---- */
.pricing-grid-2cols {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.4rem;
}

/* ---- CARDS ---- */
.card {
    padding: 1.6rem;
    border-radius: 1.4rem;
    box-shadow: 0 18px 35px rgba(122, 97, 255, 0.2);
    border: 1px solid rgba(196, 181, 253, 0.45);
    background: #ffffffee;
}

.violet-card {
    background: linear-gradient(135deg, #ffffff, #faf0ff);
}

.blue-card {
    background: linear-gradient(135deg, #ffffff, #eef6ff);
}

/* ---- FORM ---- */
.form-section {
    display: flex;
    flex-direction: column;
    gap: 1rem;
}

.field {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
}

.field label {
    font-size: 0.9rem;
    font-weight: 700;
    color: #6b21a8;
}

.field-error {
    color: #b91c1c;
    font-size: 0.82rem;
    margin-top: 0.2rem;
    font-weight: 600;
}

.input,
.select-black {
    width: 100%;
    padding: 0.6rem;
    border-radius: 0.7rem;
    border: 1px solid #dcd8ff;
    background: white;
    color: black !important;
}

/* ---- INPUT ERROR ---- */
.input-error {
    border-color: #dc2626 !important;
    background: #fff5f5 !important;
}

/* ---- RESULT ---- */
.result-value {
    font-size: 2.1rem;
    font-weight: 800;
    color: #1d4ed8;
}

.result-placeholder {
    color: #9ca3af;
}

/* ---- BUTTON ---- */
.btn-primary {
    padding: 0.8rem 2.2rem;
    border-radius: 1rem;
    border: none;
    background: linear-gradient(90deg, #7c3aed, #4b0082);
    color: white;
    font-weight: 700;
    cursor: pointer;
}

.btn-primary[disabled] {
    opacity: 0.5;
    cursor: not-allowed;
}

.pricing-method-card {
    margin-top: 0.4rem !important;
    padding-top: 1.2rem !important;
}

.pricing-method-grid {
    display: grid;
    grid-template-columns: 1fr auto; 
    align-items: center;
    gap: 1rem;
}

.option-title-strong {
    font-weight: 900;
    color: #5a189a;
}

</style>
