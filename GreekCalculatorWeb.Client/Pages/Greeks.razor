@page "/greeks"
@using Shared.DTO
@using Shared.Enums
@using GreekCalculatorWeb.Client.State
@inject HttpClient Http
@inject AppState AppState

<h2 class="page-title">GREEKS CALCULATOR</h2>

@if (pricing == null)
{
    <div class="warning-box">
        Aucun pricing trouvé !!!<br />
        Veuillez d'abord calculer un prix dans l’onglet <strong>Pricing</strong>.
    </div>
}
else
{
    <!-- ====== GRID MARKET + OPTION ====== -->
    <div class="pricing-grid-2cols">

        <!-- MARKET -->
        <div class="card violet-card">
            <h3 class="card-title violet-title option-title-strong">Marché Paramètres</h3>

            <div class="form-section">

                <div class="field">
                    <label>Ticker</label>
                    <input class="input locked" value="@pricing.Ticker" readonly />
                </div>

                <div class="field">
                    <label>Spot</label>
                    <input class="input locked" value="@pricing.Spot" readonly />
                </div>

                <div class="field">
                    <label>Volatilité σ</label>
                    <input class="input locked" value="@pricing.Vol" readonly />
                </div>

                <div class="field">
                    <label>Taux sans risque r</label>
                    <input class="input locked" value="@pricing.Rate" readonly />
                </div>

            </div>
        </div>

        <!-- OPTION -->
        <div class="card violet-card">
            <h3 class="card-title violet-title option-title-strong">Option Paramètres</h3>

            <div class="form-section">

                <div class="field">
                    <label>Strike (K)</label>
                    <input class="input locked" value="@pricing.Strike" readonly />
                </div>

                <div class="field">
                    <label>Maturité (années)</label>
                    <input class="input locked" value="@pricing.Maturity" readonly />
                </div>

                <div class="field">
                    <label>Dividend Yield</label>
                    <input class="input locked" value="@pricing.DividendYield" readonly />
                </div>

                <div class="field">
                    <label>Option Type</label>
                    <input class="input locked" value="@pricing.OptionType" readonly />
                </div>

                <div class="field">
                    <label>Option Style</label>
                    <input class="input locked" value="@pricing.OptionStyle" readonly />
                </div>

            </div>
        </div>
    </div>

    <!-- ====== GREEK METHOD ====== -->
    <div class="card violet-card pricing-method-card">
        <h3 class="card-title violet-title option-title-strong">Méthode Greeks</h3>

        <div class="pricing-method-grid">

            <div class="field">
                <select class="input select-black"
                        value="@request.GreekMethod"
                        @onchange="OnGreekMethodChanged">
                    <option value="@GreekMethod.Analytic">Analytique (BS)</option>
                    <option value="@GreekMethod.FiniteDifference">Différences Finies</option>
                </select>


                @if (GreekCompatibilityWarning() is string warn)
                {
                    <div class="field-error">@warn</div>
                }
            </div>

            <button class="btn-primary"
                    @onclick="CalculateGreeks"
                    disabled="@(!string.IsNullOrEmpty(GreekCompatibilityWarning()))">
                ▶ Calculer Greeks
            </button>

        </div>
    </div>


    @if (response != null && GreekCompatibilityWarning() == null)
    {
        <div class="greeks-pro-grid">

            <div class="greek-card-pro delta">
                <div class="greek-title"><span class="icon"></span> Delta</div>
                <div class="greek-value">@response.Delta.ToString("F4")</div>
                <div class="greek-desc">Prix de l'option par rapport à l'actif sous-jacent</div>
            </div>

            <div class="greek-card-pro gamma">
                <div class="greek-title"><span class="icon"></span> Gamma</div>
                <div class="greek-value">@response.Gamma.ToString("F4")</div>
                <div class="greek-desc">Taux de changement de Delta</div>
            </div>

            <div class="greek-card-pro theta">
                <div class="greek-title"><span class="icon"></span> Theta</div>
                <div class="greek-value">@response.Theta.ToString("F4")</div>
                <div class="greek-desc">Diminution de la valeur temps par jour</div>
            </div>

            <div class="greek-card-pro vega">
                <div class="greek-title"><span class="icon"></span> Vega</div>
                <div class="greek-value">@response.Vega.ToString("F4")</div>
                <div class="greek-desc">Sensibilité à la volatilité</div>
            </div>

            <div class="greek-card-pro rho">
                <div class="greek-title"><span class="icon"></span> Rho</div>
                <div class="greek-value">@response.Rho.ToString("F4")</div>
                <div class="greek-desc">Sensibilité au taux d'intérêt</div>
            </div>

            <div class="greek-card-pro vanna">
                <div class="greek-title"><span class="icon"></span> Vanna</div>
                <div class="greek-value">@response.Vanna.ToString("F4")</div>
                <div class="greek-desc">Sensibilité à la volatilité et à l'actif sous-jacent</div>
            </div>

            <div class="greek-card-pro vomma">
                <div class="greek-title"><span class="icon"></span> Vomma</div>
                <div class="greek-value">@response.Vomma.ToString("F4")</div>
                <div class="greek-desc">Sensibilité de Vega à la volatilité</div>
            </div>

            <div class="greek-card-pro zomma">
                <div class="greek-title"><span class="icon"></span> Zomma</div>
                <div class="greek-value">@response.Zomma.ToString("F4")</div>
                <div class="greek-desc">Sensibilité de Gamma à la volatilité</div>
            </div>
        </div>

        <!-- ====== INSIGHT ANALYTICS ====== -->
        @if (response != null && GreekCompatibilityWarning() == null)
        {       
            <div class="insight-card">
                <h3 class="insight-title">Analyse des Greeks :</h3>
                <ul class="insight-list">

                    <li>
                        <strong>Delta (@response.Delta.ToString("F3"))</strong>  
                        indique que le prix de l’option varie d’environ 
                        <strong>@response.Delta.ToString("F2") €</strong> pour chaque mouvement de 1 € du sous-jacent.
                    </li>

                    <li>
                        <strong>Gamma (@response.Gamma.ToString("F4"))</strong>  
                        mesure la vitesse à laquelle le Delta change.  
                        Une valeur élevée signifie une sensibilité accrue lors de variations du sous-jacent.
                    </li>

                    <li>
                        <strong>Theta (@response.Theta.ToString("F4"))</strong>  
                        représente la perte quotidienne due au passage du temps :  
                        l’option perd environ <strong>@Math.Abs(response.Theta).ToString("F2") €</strong> par jour.
                    </li>

                    <li>
                        <strong>Vega (@response.Vega.ToString("F4"))</strong>  
                        signifie qu’une hausse de 1% de la volatilité fait varier le prix de l’option d’environ  
                        <strong>@response.Vega.ToString("F2") €</strong>.
                    </li>

                    <li>
                        <strong>Rho (@response.Rho.ToString("F4"))</strong>  
                        exprime la sensibilité aux taux d'intérêt : une hausse de 1% du taux fait varier le prix de  
                        <strong>@response.Rho.ToString("F2") €</strong>.
                    </li>

                    <li>
                        <strong>Vanna (@response.Vanna.ToString("F4"))</strong>  
                        décrit comment le Delta réagit aux changements de volatilité.  
                        Il est utile pour analyser la dynamique de volatilité et le skew.
                    </li>

                    <li>
                        <strong>Vomma (@response.Vomma.ToString("F4"))</strong>  
                        mesure comment le Vega évolue avec la volatilité.  
                        Une Vomma élevée indique une forte convexité de la sensibilité à la volatilité.
                    </li>

                    <li>
                        <strong>Zomma (@response.Zomma.ToString("F4"))</strong>  
                        représente la sensibilité du Gamma à la volatilité et met en évidence des risques de convexité de second ordre.
                    </li>
        </ul>
            </div>
        }
    }
}

@code {

    PricingRequest? pricing;
    GreeksRequest request = new();
    GreeksResponse? response;
    protected override void OnInitialized()
    {
        pricing = AppState.LastPricing;

        if (pricing == null)
            return;

        request = new GreeksRequest
        {
            Ticker        = pricing.Ticker,
            Spot          = pricing.Spot,
            Strike        = pricing.Strike,
            Rate          = pricing.Rate,
            Maturity      = pricing.Maturity,
            Volatility    = pricing.Vol,
            DividendYield = pricing.DividendYield,
            OptionType    = pricing.OptionType,
            OptionStyle   = pricing.OptionStyle,
            PricingMethod = pricing.PricingMethod,
            GreekMethod   = GreekMethod.Analytic
        };
    }

    void OnGreekMethodChanged(ChangeEventArgs e)
    {
        if (Enum.TryParse<GreekMethod>(e.Value?.ToString(), out var gm))
            request.GreekMethod = gm;

        response = null; 
        StateHasChanged();
    }

    string? GreekCompatibilityWarning()
    {
        if (request.OptionStyle == OptionStyle.American &&
            request.GreekMethod == GreekMethod.Analytic)
            return " Les Greeks analytiques (Black-Scholes) ne sont pas disponibles pour les options américaines !";

        return null;
    }

    async Task CalculateGreeks()
    {
        if (!string.IsNullOrEmpty(GreekCompatibilityWarning()))
            return;

        var r = await Http.PostAsJsonAsync("api/greeks", request);

        if (r.IsSuccessStatusCode)
            response = await r.Content.ReadFromJsonAsync<GreeksResponse>();
    }
}

<style>

/* ---- PAGE TITLE ---- */
.page-title {
    font-size: 2.3rem;
    text-align: center;
    font-weight: 900;
    margin-bottom: 1.5rem;
    color: #4b0082;
}

/* ---- WARNING ---- */
.warning-box {
    text-align: center;
    margin-top: 2rem;
    background: #fff3f3;
    padding: 1.3rem;
    border-radius: 1rem;
    color: #b91c1c;
    font-weight: 700;
    font-size: 1.1rem;
    border: 1px solid #fca5a5;
}

/* ---- GRID ---- */
.pricing-grid-2cols {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.4rem;
}

/* ---- CARDS ---- */
.card {
    padding: 1.6rem;
    border-radius: 1.4rem;
    box-shadow: 0 18px 35px rgba(122, 97, 255, 0.2);
    border: 1px solid rgba(196, 181, 253, 0.45);
    background: #ffffffee;
    backdrop-filter: blur(10px);
}

.violet-card {
    background: linear-gradient(135deg, #ffffff, #faf0ff);
}

.violet-title {
    color: #6b21a8;
}

.option-title-strong {
    font-weight: 900;
    color: #5a189a;
}

/* ---- INPUT ---- */
.field {
    display: flex;
    flex-direction: column;
    gap: 0.35rem;
}

.field label {
    font-size: 0.9rem;
    font-weight: 700;
    color: #6b21a8;
}

.input {
    padding: 0.6rem;
    border-radius: 0.7rem;
    border: 1px solid #dcd8ff;
    background: white;
    font-size: 0.95rem;
    color: black !important;
}

.locked {
    background: #f4efff;
    font-weight: 600;
}

/* ---- GREEK METHOD ---- */
.pricing-method-card {
    margin-top: 0.4rem;
}

.pricing-method-grid {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 1rem;
    align-items: center;
}

/* ---- BUTTON ---- */
.btn-primary {
    padding: 0.8rem 2.2rem;
    border-radius: 1rem;
    background: linear-gradient(90deg, #7c3aed, #4b0082);
    color: white;
    font-weight: 700;
    cursor: pointer;
}

/* ---- PRO GREEK GRID ---- */
.greeks-pro-grid {
    margin-top: 1.4rem;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.4rem;
}

.greek-card-pro {
    padding: 1.4rem;
    border-radius: 1.2rem;
    background: white;
    box-shadow: 0 12px 28px rgba(0, 0, 0, 0.07);
    display: flex;
    flex-direction: column;
    gap: 0.3rem;
}

/* ---- TEXT ---- */
.greek-title {
    font-size: 1.1rem;
    font-weight: 700;
}

.greek-value {
    font-size: 2rem;
    font-weight: 800;
}

.greek-desc {
    font-size: 0.9rem;
    opacity: 0.7;
}

/* ---- ICON ---- */
.icon {
    font-size: 1.25rem;
}

/* ---- COLORS ---- */
.delta  { background: #eef4ff; color: #1d4ed8; }
.gamma  { background: #e8fced; color: #166534; }
.theta  { background: #fff1f1; color: #b91c1c; }
.vega   { background: #f6efff; color: #6d28d9; }
.rho    { background: #fff6e8; color: #b45309; }
.vanna  { background: #eaf9ff; color: #0369a1; }
.vomma  { background: #fdeeff; color: #9d174d; }
.zomma  { background: #eaf4ff; color: #1e3a8a; }

/* --- INSIGHT ANALYTICS CARD --- */
.insight-card {
    margin-top: 1.4rem;
    padding: 1.6rem 1.6rem;
    border-radius: 1.2rem;
    background: #fffbea;
    border: 1px solid #fde68a;
    box-shadow: 0 8px 25px rgba(0,0,0,0.05);
}

.insight-title {
    font-size: 1.35rem;
    font-weight: 800;
    margin-bottom: 0.6rem;
    color: #92400e;
}

.insight-list {
    list-style-type: disc;
    padding-left: 1.3rem;
    color: #7c2d12;
    line-height: 1.55rem;
    font-size: 1.05rem;
}

/* ---- RESPONSIVE ---- */
@@media (max-width: 980px) {
    .pricing-grid-2cols { grid-template-columns: 1fr; }
    .greeks-pro-grid { grid-template-columns: repeat(4, 1fr); }
}

</style>
